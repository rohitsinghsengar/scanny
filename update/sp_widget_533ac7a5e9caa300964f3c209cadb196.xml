<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function() {
  /* widget controller */
  var c = this;
	
	c.submit = function(){
		var issueSelect = angular.element(document.querySelector('#issueSelect'));
		c.data.problem = issueSelect.val();
		var detailTextarea = angular.element(document.querySelector('#detailTextarea'));
		c.data.problem_desc = detailTextarea.val();
		c.data.action = "logIncident";
		c.server.update().then(function(){
			c.data.action = undefined;
		});
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.container{
	padding: 0px 15px;
}
.tab-pane{
	margin-top: 10px;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>scanny_form</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>scanny_form</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	data.show = false;
	data.incident = '';
	data.incident_id = '';
	data.showMsg = false;
	data.device = {};
	data.issues = [];
	data.nearbyDevices = [];
	data.relatedKbas = [];
	
	var sys_id = $sp.getParameter('sys_id');
	if(sys_id)
		data.show = true;
	else
		return false;
	
	var gr = new GlideRecord('x_scanny_scanny');
	gr.get('sys_id',sys_id);
	for(var issue in gr.issues){
		data.issues.push({'key':issue, 'val':gr.issues[issue]});	
	}
	var device = gr.asset.getRefRecord();
	data.device.name = device.display_name.toString();
	data.device.model = device.model.toString();
	data.device.assetTag = device.asset_tag.toString();
	data.device.location = device.location.toString();
	
	var grAsset = new GlideRecord('alm_asset');
	grAsset.addQuery('sys_id', 'IN', gr.nearby);
	grAsset.addJoinQuery('cmn_location','location');
	grAsset.query();
	while(grAsset.next()) {
		data.nearbyDevices.push(grAsset.display_name.toString()+', Location: '+grAsset.location.name.toString());
  }
	
	var grKb = new GlideRecord('kb_knowledge');
	grKb.addQuery('sys_id', 'IN', gr.suggestions);
	grKb.query();
	while(grKb.next()) {
		data.relatedKbas.push({'sys_id':grKb.sys_id.toString(),'title':grKb.short_description.toString()});
  }
	
	if(input && input.action == "logIncident"){
			var grInci = new GlideRecord('incident');
			grInci.initialize();
			grInci.short_description = input.problem+' Device: '+data.device.name;
			grInci.category = 'hardware';
			grInci.caller_id = gs.getUserID();
			grInci.description = input.problem_desc+'\nDevice- '+data.device.name+'\nModel- '+data.device.model+'\nLocation- '+data.device.location;
			grInci.insert();
			data.incident_id = grInci.sys_id.toString();
			data.incident = grInci.number.toString();
			data.showMsg = true;
	}
	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-11-28 11:16:13</sys_created_on>
        <sys_id>533ac7a5e9caa300964f3c209cadb196</sys_id>
        <sys_mod_count>104</sys_mod_count>
        <sys_name>scanny_form</sys_name>
        <sys_package display_value="scanny" source="x_scanny">ba351ec7e9f12300964f3c209cadb113</sys_package>
        <sys_policy/>
        <sys_scope display_value="scanny">ba351ec7e9f12300964f3c209cadb113</sys_scope>
        <sys_update_name>sp_widget_533ac7a5e9caa300964f3c209cadb196</sys_update_name>
        <sys_updated_by>maint</sys_updated_by>
        <sys_updated_on>2018-11-28 20:08:45</sys_updated_on>
        <template><![CDATA[<div class="container" ng-show="c.data.show">
<h1>Facing Problems with this device?</h1>
  <label>Device: <strong>{{data.device.name}}</strong></label>
<div ng-show="c.data.showMsg" class="alert alert-success" role="alert">
  An incident <a href="/sp?id=ticket&table=incident&sys_id={{data.incident_id}}" target="_blank">{{data.incident}}</a> has been logged against this device.
</div>
<form ng-hide="c.data.showMsg">
  <div class="form-group">
    <label for="issueSelect">What's the issue?</label>
    <select class="form-control" id="issueSelect">
      <option ng-repeat="issue in data.issues" value="{{issue.val}}">{{issue.key}}</option>
    </select>
  </div>
  <div class="form-group">
    <label for="detailTextarea">Can you explain?</label>
    <textarea class="form-control" id="detailTextarea" rows="3"></textarea>
  </div>
  <button type="submit" ng-click="c.submit()" class="btn btn-primary">Submit</button>
</form>
<br />
<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Nearby Devices</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Suggested KB Articles</a>
  </li>
</ul>
<div class="tab-content" id="myTabContent">
  <div class="tab-pane fade active" id="home" role="tabpanel" aria-labelledby="home-tab">
    <ul>
      <li ng-repeat="device in data.nearbyDevices">{{device}}</li>
    </ul>
  </div>
  <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
    <ul>
      <li ng-repeat="kb in data.relatedKbas">
        <a href="/sp?id=kb_article&sys_id={{kb.sys_id}}" target="_blank">{{kb.title}}</a>
      </li>
    </ul>
  </div>
</div>
</div>]]></template>
    </sp_widget>
</record_update>
